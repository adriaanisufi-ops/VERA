<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verhalen</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1020;
      --bg2:#0f1732;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: #eef2ff;
      --muted: rgba(238,242,255,.70);
      --border: rgba(255,255,255,.12);
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --danger:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(139,92,246,.30), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(34,211,238,.22), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .container{
      max-width: 980px;
      margin: 26px auto;
      padding: 0 14px 60px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 14px 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; flex-direction:column; gap:4px;
      min-width: 0;
    }
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font: inherit;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); opacity:.92; }

    .btn-primary{
      border-color: rgba(139,92,246,.35);
      background: linear-gradient(135deg, rgba(139,92,246,.85), rgba(34,211,238,.70));
      box-shadow: 0 10px 24px rgba(139,92,246,.18);
    }
    .btn-primary:hover{ background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.80)); }

    .status{
      margin: 14px 4px 0;
      color: var(--muted);
      font-size: 14px;
    }
    .error{
      margin: 10px 4px 0;
      color: var(--danger);
      white-space: pre-wrap;
      font-size: 14px;
    }

    /* Cards */
    .story{
      margin-top: 14px;
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(10px);
      opacity: 0;
      animation: fadeUp .35s ease forwards;
    }
    @keyframes fadeUp{
      to{ transform: translateY(0); opacity:1; }
    }

    .story-head{ padding: 16px 16px 8px; }
    .story h2{
      margin:0;
      font-size: 17px;
      letter-spacing: -0.02em;
      line-height: 1.25;
    }
    .meta{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
    }

    .story-body{
      padding: 0 16px 14px;
      line-height: 1.75;
      white-space: pre-wrap;
      color: rgba(238,242,255,.92);
    }

    .story-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .small{ font-size: 13px; color: var(--muted); }

    /* Comments */
    .comments{
      display:none;
      padding: 12px 16px 16px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .comments.open{ display:block; }

    .comment{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
      background: rgba(255,255,255,.06);
    }
    .comment p{ margin: 8px 0 0; white-space: pre-wrap; line-height: 1.55; color: rgba(238,242,255,.92); }

    .form{ margin-top: 12px; display:grid; gap:10px; }
    input, textarea{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font: inherit;
      outline: none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(238,242,255,.55); }
    textarea{ min-height: 110px; resize: vertical; }

    .row{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap: wrap; }
    .hint{ color: var(--muted); font-size: 13px; }

    /* Mobile polish */
    @media (max-width: 520px){
      .container{ margin: 18px auto; }
      .topbar{ padding: 12px; }
      .brand h1{ font-size: 18px; }
      .btn{ width: 100%; }
      .topbar{ flex-direction: column; align-items: stretch; }
      .story-head, .story-body, .story-actions, .comments{ padding-left: 12px; padding-right: 12px; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .story{ animation: none; opacity:1; transform:none; }
      .btn{ transition:none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>Verhalen</h1>
        <p>Lees, deel en reageer ‚Äî met respect.</p>
      </div>
      <a class="btn btn-primary" href="deel.html">Deel jouw verhaal</a>
    </div>

    <div id="status" class="status">Verhalen laden...</div>
    <div id="error" class="error"></div>
    <div id="stories"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    function escapeHtml(str){return (str??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
    function fmtDate(ts){ try { return new Date(ts).toLocaleString("nl-NL"); } catch { return ""; } }

    async function loadStories(){
      const statusEl=document.getElementById("status");
      const errorEl=document.getElementById("error");
      const wrap=document.getElementById("stories");
      errorEl.textContent=""; wrap.innerHTML="";

      try{
        if(!window.supabaseClient) throw new Error("Supabase client niet geladen. Controleer supabase.js");

        const { data, error } = await window.supabaseClient
          .from("stories")
          .select("id,title,author_name,created_at,content")
          .order("created_at",{ascending:false})
          .limit(50);

        if(error) throw error;

        if(!data || data.length===0){
          statusEl.textContent="Nog geen verhalen. Wees de eerste!";
          return;
        }

        statusEl.textContent="";

        data.forEach((s, i)=>{
          const el=document.createElement("section");
          el.className="story";
          el.style.animationDelay = (i * 30) + "ms";
          el.innerHTML=`
            <div class="story-head">
              <h2>${escapeHtml(s.title)}</h2>
              <div class="meta">
                <span class="pill">üóìÔ∏è ${fmtDate(s.created_at)}</span>
                ${s.author_name ? `<span class="pill">üë§ ${escapeHtml(s.author_name)}</span>` : ""}
              </div>
            </div>

            <div class="story-body">${escapeHtml(s.content)}</div>

            <div class="story-actions">
              <button class="btn" data-action="toggle-comments" data-story="${s.id}">üí¨ Reacties</button>
              <span class="small" id="count-${s.id}"></span>
            </div>

            <div class="comments" id="comments-${s.id}">
              <div class="hint" id="cstatus-${s.id}">Reacties laden...</div>
              <div id="clist-${s.id}"></div>

              <form class="form" data-action="comment-form" data-story="${s.id}">
                <input name="author" placeholder="Jouw naam (optioneel)" />
                <textarea name="content" placeholder="Schrijf een reactie..." required></textarea>
                <div class="row">
                  <span class="hint" id="cmsg-${s.id}"></span>
                  <button class="btn btn-primary" type="submit">Plaats reactie</button>
                </div>
              </form>
            </div>
          `;
          wrap.appendChild(el);
        });

        wrap.addEventListener("click", async (e)=>{
          const btn=e.target.closest("[data-action='toggle-comments']");
          if(!btn) return;
          const storyId=btn.getAttribute("data-story");
          const panel=document.getElementById(`comments-${storyId}`);
          const isOpen=panel.classList.toggle("open");
          btn.textContent = isOpen ? "üôà Verbergen" : "üí¨ Reacties";
          if(isOpen) await loadComments(storyId);
        });

        wrap.addEventListener("submit", async (e)=>{
          const form=e.target.closest("[data-action='comment-form']");
          if(!form) return;
          e.preventDefault();
          const storyId=form.getAttribute("data-story");
          await submitComment(form, storyId);
        });

        data.forEach(s => loadCommentCount(s.id));

      }catch(err){
        console.error(err);
        statusEl.textContent="";
        errorEl.textContent="Fout:\n"+(err?.message||String(err));
      }
    }

    async function loadCommentCount(storyId){
      try{
        const { count, error } = await window.supabaseClient
          .from("comments")
          .select("id", { count: "exact", head: true })
          .eq("story_id", storyId);
        if(error) throw error;
        const el=document.getElementById(`count-${storyId}`);
        if(el) el.textContent=`${count ?? 0} reactie(s)`;
      }catch{}
    }

    async function loadComments(storyId){
      const statusEl=document.getElementById(`cstatus-${storyId}`);
      const listEl=document.getElementById(`clist-${storyId}`);
      statusEl.textContent="Reacties laden..."; listEl.innerHTML="";

      try{
        const { data, error } = await window.supabaseClient
          .from("comments")
          .select("id,author_name,content,created_at")
          .eq("story_id", storyId)
          .order("created_at",{ascending:true});
        if(error) throw error;

        if(!data || data.length===0){
          statusEl.textContent="Nog geen reacties. Wees de eerste!";
          return;
        }

        statusEl.textContent="";
        data.forEach(c=>{
          const div=document.createElement("div");
          div.className="comment";
          div.innerHTML=`
            <div class="meta">
              ${c.author_name ? `<span class="pill">üë§ ${escapeHtml(c.author_name)}</span>` : ""}
              <span class="pill">üóìÔ∏è ${fmtDate(c.created_at)}</span>
            </div>
            <p>${escapeHtml(c.content)}</p>
          `;
          listEl.appendChild(div);
        });

      }catch(err){
        console.error(err);
        statusEl.textContent="Fout bij laden reacties: "+(err?.message||String(err));
      }
    }

    async function submitComment(form, storyId){
      const msgEl=document.getElementById(`cmsg-${storyId}`);
      msgEl.textContent="Plaatsen...";
      const author=(form.elements.author.value||"").trim();
      const content=(form.elements.content.value||"").trim();

      try{
        const { error } = await window.supabaseClient
          .from("comments")
          .insert({ story_id: storyId, author_name: author||null, content });
        if(error) throw error;

        form.reset();
        msgEl.textContent="‚úÖ Geplaatst!";
        setTimeout(()=>msgEl.textContent="",1200);

        await loadComments(storyId);
        await loadCommentCount(storyId);

      }catch(err){
        console.error(err);
        msgEl.textContent="‚ùå "+(err?.message||String(err));
      }
    }

    loadStories();
  </script>
</body>
</html>
